{% extends "base.html" %}

{% block content %}
<section class="booking-section py-5">
    <div class="container">
        <h2 class="text-center mb-5">Pilih Jadwal Latihan</h2>
        
        <!-- Booking Type Selection -->
        <div class="row mb-4">
            <div class="col-lg-8 mx-auto">
                <div class="booking-type-selector text-center">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary active" data-booking-type="regular">Regular (4 Minggu)</button>
                        <button type="button" class="btn btn-outline-primary" data-booking-type="daily">Trial / Harian</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="booking-form">
                    <form id="bookingForm" action="{{ url_for('process_booking') }}" method="POST">
                        <!-- Hidden input for booking type -->
                        <input type="hidden" name="booking_type" id="bookingType" value="regular">

                        <!-- Location Selection -->
                        <div class="mb-4">
                            <label for="location" class="form-label">Lokasi</label>
                            <select class="form-select" id="location" name="location" required>
                                <option value="">Pilih Lokasi</option>
                                {% for location in locations %}
                                <option value="{{ location.id }}">{{ location.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Date Selection -->
                        <div class="mb-4">
                            <label for="date" class="form-label">Tanggal</label>
                            <input type="date" class="form-control" id="date" name="date" required>
                        </div>

                        <!-- Time Slot Selection -->
                        <div class="mb-4">
                            <label class="form-label">Pilih Waktu</label>
                            <div id="timeSlots" class="time-slots">
                                <!-- Time slots will be populated dynamically -->
                            </div>
                        </div>

                        <!-- Consecutive Dates Preview (only for regular bookings) -->
                        <div id="consecutiveDates" class="consecutive-dates mb-4" style="display: none;">
                            <h4 class="mb-3">Jadwal 4 Minggu Kedepan:</h4>
                            <div class="consecutive-dates-list">
                                <!-- Will be populated dynamically -->
                            </div>
                        </div>

                        <div class="text-center">
                            <button type="submit" class="btn btn-primary" id="submitButton" disabled>
                                Konfirmasi Booking
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const bookingForm = document.getElementById('bookingForm');
    const locationSelect = document.getElementById('location');
    const dateInput = document.getElementById('date');
    const timeSlotsDiv = document.getElementById('timeSlots');
    const consecutiveDatesDiv = document.getElementById('consecutiveDates');
    const submitButton = document.getElementById('submitButton');
    const bookingTypeButtons = document.querySelectorAll('[data-booking-type]');
    const bookingTypeInput = document.getElementById('bookingType');
    
    // Set minimum date to today
    const today = new Date().toISOString().split('T')[0];
    dateInput.min = today;

    // Booking type selection
    bookingTypeButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Update active state
            bookingTypeButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            // Update hidden input
            const bookingType = this.dataset.bookingType;
            bookingTypeInput.value = bookingType;
            
            // Show/hide consecutive dates section
            consecutiveDatesDiv.style.display = bookingType === 'regular' ? 'block' : 'none';
            
            // Reset form
            submitButton.disabled = true;
            updateTimeSlots();
        });
    });

    // Event listeners for form inputs
    locationSelect.addEventListener('change', updateTimeSlots);
    dateInput.addEventListener('change', updateTimeSlots);

    function updateTimeSlots() {
        const locationId = locationSelect.value;
        const date = dateInput.value;
        const bookingType = bookingTypeInput.value;
        
        if (bookingType === 'regular') {
            consecutiveDatesDiv.style.display = 'none';
        }
        submitButton.disabled = true;

        if (locationId && date) {
            fetch('/get_available_slots', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `location_id=${locationId}&date=${date}`
            })
            .then(response => response.json())
            .then(data => {
                timeSlotsDiv.innerHTML = '';
                data.available_slots.forEach(slot => {
                    const disabled = slot.available <= 0;
                    timeSlotsDiv.innerHTML += `
                        <div class="time-slot-option">
                            <input type="radio" name="timeSlot" 
                                   id="slot_${slot.start_time}" 
                                   value="${slot.start_time}-${slot.end_time}"
                                   ${disabled ? 'disabled' : ''}>
                            <label for="slot_${slot.start_time}" class="${disabled ? 'disabled' : ''}">
                                ${slot.start_time} - ${slot.end_time}
                                <span class="availability">${slot.available}/${slot.total_quota} tersedia</span>
                            </label>
                        </div>
                    `;
                });

                // Add event listeners to new radio buttons
                document.querySelectorAll('input[name="timeSlot"]').forEach(radio => {
                    radio.addEventListener('change', function() {
                        if (bookingTypeInput.value === 'regular') {
                            checkConsecutiveDates();
                        } else {
                            submitButton.disabled = false;
                        }
                    });
                });
            });
        }
    }

    function checkConsecutiveDates() {
        const locationId = locationSelect.value;
        const date = dateInput.value;
        const selectedTimeSlot = document.querySelector('input[name="timeSlot"]:checked').value;
        const [startTime, endTime] = selectedTimeSlot.split('-');

        fetch('/get_consecutive_dates', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `location_id=${locationId}&date=${date}&start_time=${startTime}&end_time=${endTime}`
        })
        .then(response => response.json())
        .then(data => {
            consecutiveDatesDiv.style.display = 'block';
            const datesList = consecutiveDatesDiv.querySelector('.consecutive-dates-list');
            datesList.innerHTML = '';

            let allDatesAvailable = true;
            data.consecutive_dates.forEach(dateInfo => {
                datesList.innerHTML += `
                    <div class="date-item ${dateInfo.is_available ? 'available' : 'unavailable'}">
                        <span class="date">${dateInfo.formatted_date}</span>
                        <span class="time">${dateInfo.start_time} - ${dateInfo.end_time}</span>
                        <span class="quota">${dateInfo.available_quota}/${dateInfo.total_quota} tersedia</span>
                    </div>
                `;
                if (!dateInfo.is_available) {
                    allDatesAvailable = false;
                }
            });

            submitButton.disabled = !allDatesAvailable;
        });
    }

    bookingForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const selectedTimeSlot = document.querySelector('input[name="timeSlot"]:checked').value;
        const [startTime, endTime] = selectedTimeSlot.split('-');
        
        const formData = new FormData();
        formData.append('location_id', locationSelect.value);
        formData.append('date', dateInput.value);
        formData.append('start_time', startTime);
        formData.append('end_time', endTime);
        formData.append('booking_type', bookingTypeInput.value);

        fetch('/book_session', {
            method: 'POST',
            body: new URLSearchParams(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = `/booking_confirmation/${data.booking_id}`;
            } else {
                alert(data.message || 'Terjadi kesalahan. Silakan coba lagi.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Terjadi kesalahan. Silakan coba lagi.');
        });
    });
});
</script>
{% endblock %} 